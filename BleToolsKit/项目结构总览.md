# BleToolsKit 项目结构总览

## 📁 完整目录结构

```
BleToolsKit/
│
├── 📂 Core/                                    # 核心功能层
│   ├── BleAPI.swift                           # ⭐️ 对外 API 接口（重构版）
│   ├── BleCentral.swift                       # 蓝牙中心管理器（需更新引用）
│   └── BleConstants.swift                     # 常量定义
│
├── 📂 Models/                                  # 数据模型层
│   ├── BleDevice.swift                        # 设备模型（实现 BleDeviceProtocol）
│   ├── BleFilter.swift                        # 扫描过滤器配置
│   └── BleError.swift                         # 错误定义
│
├── 📂 Protocols/                               # 协议层（扩展接口）
│   ├── BleDeviceProtocol.swift                # 设备协议
│   ├── BleFilterProtocol.swift                # 过滤器协议
│   └── BleCommandProtocol.swift               # 命令协议
│
├── 📂 Filters/                                 # 过滤器实现层
│   └── BleDeviceNameFilter.swift              # 设备名称过滤器
│       ├── BleDeviceNameFilter                # 名称过滤器（实现 BleFilterProtocol）
│       ├── BleRSSIFilter                      # RSSI 过滤器
│       └── BleDeviceTypeFilter                # 设备类型过滤器
│
├── 📂 Devices/                                 # 设备管理层
│   └── BleDeviceManager.swift                 # 设备管理器
│       ├── buildBindCommand()                 # 构建绑定指令
│       ├── buildCommand()                     # 构建设备命令
│       ├── parseData()                        # 解析设备数据
│       ├── getServiceUUIDs()                  # 获取服务 UUID
│       └── getCharacteristicUUIDs()           # 获取特征 UUID
│
├── 📂 Commands/                                # 命令定义层
│   └── SpiromerterCommands.swift              # 肺活量计命令
│       ├── SpirometerCommand                  # 命令枚举
│       ├── SpirometerCommandBuilder           # 命令构建器
│       └── SpirometerCommandImpl              # 命令实现（实现 BleCommandProtocol）
│   # 未来可扩展：
│   # ├── OximeterCommands.swift              # 血氧仪命令
│   # ├── ThermometerCommands.swift           # 体温计命令
│   # └── ...
│
├── 📂 Storage/                                 # 存储层
│   └── BleStorage.swift                       # 本地存储管理
│       ├── saveMacAddress()                   # 保存 MAC 地址
│       ├── getMacAddress()                    # 获取 MAC 地址
│       ├── isNewDevice()                      # 判断是否为新设备
│       └── loadDeviceMacMapping()             # 加载设备映射
│
├── 📂 Utils/                                   # 工具层
│   ├── 📂 Crypto/                             # 加密工具
│   │   └── AESCBCUtil.swift                   # AES-CBC 加密
│   │       ├── encryptHexStringZeroPadding()  # 密钥池加密
│   │       └── encryptHexStringWithFixedKey() # 固定密钥加密
│   │
│   ├── 📂 Converters/                         # 数据转换工具
│   │   ├── BleDataConverter.swift             # 蓝牙数据转换
│   │   │   ├── hexStringToData()             # 十六进制转 Data
│   │   │   ├── dataToHexString()             # Data 转十六进制
│   │   │   └── getCurrentHexTimes()          # 获取当前时间十六进制
│   │   │
│   │   ├── DataConverter.swift                # 通用数据转换
│   │   │   ├── calculateCRC()                # 计算 CRC
│   │   │   ├── getTerminator()               # 计算校验和
│   │   │   └── reversedHexString()           # 反转十六进制字符串
│   │   │
│   │   └── Base64Converter.swift              # Base64 转换
│   │
│   └── 📂 Extensions/                         # 扩展（预留）
│       └── Data+Hex.swift                     # Data 十六进制扩展
│
├── 📂 BleToolsKit.docc/                       # 文档
│   ├── BleToolsKit.md
│   └── Resources/
│
├── 📄 BleAPI.swift                            # ⚠️ 旧版本（待迁移）
├── 📄 BleCentral.swift                        # ⚠️ 旧版本（待迁移）
├── 📄 BlePublic.swift                         # ⚠️ 旧版本（已拆分到 Models/）
├── 📄 BleDeviceNameFilter.swift               # ⚠️ 旧版本（已迁移到 Filters/）
├── 📄 BleStorage.swift                        # ⚠️ 旧版本（已复制到 Storage/）
├── 📄 BleConstants.swift                      # ⚠️ 旧版本（已复制到 Core/）
├── 📄 AESCBCutil.swift                        # ⚠️ 旧版本（已复制到 Utils/Crypto/）
├── 📄 BleDataConverter.swift                  # ⚠️ 旧版本（已复制到 Utils/Converters/）
├── 📄 DataConverter.swift                     # ⚠️ 旧版本（已复制到 Utils/Converters/）
└── 📄 Base64Converter.swift                   # ⚠️ 旧版本（已复制到 Utils/Converters/）
```

## 📊 模块依赖关系

```
┌─────────────────────────────────────────────────────────┐
│                       BleAPI                            │  ⬅️ 对外接口层
│                    (Core/BleAPI.swift)                  │
└───────────┬─────────────────────────────────────────────┘
            │
            │ 依赖
            ▼
┌───────────────────────────────────────────────────────┐
│                    BleCentral                          │  ⬅️ 蓝牙通信层
│                 (Core/BleCentral.swift)                │
└───────────┬───────────────────────────────────────────┘
            │
            │ 使用
            ▼
┌───────────────────────────────────────────────────────┐
│                 BleDeviceManager                       │  ⬅️ 设备管理层
│             (Devices/BleDeviceManager.swift)           │
└───────────┬───────────────────────────────────────────┘
            │
            │ 依赖
            ▼
┌───────────────────────────────────────────────────────┐
│          Commands (设备命令)                           │  ⬅️ 命令层
│        SpiromerterCommands.swift                       │
│        OximeterCommands.swift (未来)                   │
└───────────┬───────────────────────────────────────────┘
            │
            │ 实现
            ▼
┌───────────────────────────────────────────────────────┐
│          Protocols (协议接口)                          │  ⬅️ 协议层
│    BleDeviceProtocol, BleFilterProtocol,              │
│    BleCommandProtocol                                  │
└───────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────┐
│          Models (数据模型)                             │  ⬅️ 数据层
│    BleDevice, BleFilter, BleError                     │
└───────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────┐
│          Utils (工具类)                                │  ⬅️ 工具层
│    Crypto, Converters, Extensions                     │
└───────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────┐
│          Storage (存储)                                │  ⬅️ 存储层
│         BleStorage.swift                               │
└───────────────────────────────────────────────────────┘
```

## 🔄 数据流向

### 扫描流程

```
用户调用
  ↓
BleAPI.scan()
  ↓
BleCentral.startScan()
  ↓
应用过滤器 (BleFilterProtocol)
  ↓
发现设备 → BleDevice
  ↓
转换为 BleDeviceInfo
  ↓
回调 onDeviceFound
  ↓
用户接收设备信息
```

### 连接流程

```
用户调用
  ↓
BleAPI.connect(deviceId)
  ↓
BleCentral.connect(device)
  ↓
发现服务和特征
  ↓
BleDeviceManager 获取配置
  ↓
发送绑定指令
  ↓
订阅通知特征
  ↓
回调 onConnected
```

### 命令发送流程

```
用户调用 (如 ble.fvc())
  ↓
BleAPI 转发
  ↓
BleCentral 处理
  ↓
BleDeviceManager.buildCommand()
  ↓
SpirometerCommandBuilder 构建命令
  ↓
AESCBCUtil 加密（新设备）
  ↓
BleCentral.write() 发送
  ↓
设备响应 → onDataReceived
```

## 🎯 核心类职责

### 1. BleAPI (Core/BleAPI.swift)
**职责**：对外统一接口  
**功能**：
- 提供扫描、连接、发送数据的简单接口
- 管理回调设置
- 协调各层模块工作
- 设备信息转换（内部 BleDevice → 对外 BleDeviceInfo）

### 2. BleCentral (Core/BleCentral.swift)
**职责**：蓝牙通信核心  
**功能**：
- 管理 CBCentralManager
- 扫描、连接、断开设备
- 发现服务和特征
- 读写数据、订阅通知
- 处理蓝牙状态变化

### 3. BleDeviceManager (Devices/BleDeviceManager.swift)
**职责**：设备类型管理  
**功能**：
- 构建不同设备的命令
- 解析不同设备的数据
- 提供设备配置信息（服务/特征 UUID）
- 统一多设备类型的接口

### 4. SpirometerCommands (Commands/SpiromerterCommands.swift)
**职责**：肺活量计命令封装  
**功能**：
- 定义肺活量计所有命令
- 提供命令构建逻辑
- 实现 BleCommandProtocol

### 5. BleStorage (Storage/BleStorage.swift)
**职责**：本地数据持久化  
**功能**：
- MAC 地址映射存储
- 新老设备判断
- UserDefaults 管理

### 6. Utils (Utils/)
**职责**：通用工具函数  
**功能**：
- 加密解密（AESCBCUtil）
- 数据格式转换（Converters）
- 扩展功能（Extensions）

## 🚀 扩展点

### 1. 添加新设备类型

在以下位置添加代码：

1. **BleDeviceProtocol.swift**
   ```swift
   public enum BleDeviceType {
       case newDeviceType = "NewDevice"  // 添加新类型
   }
   ```

2. **Commands/NewDeviceCommands.swift**
   ```swift
   // 创建新文件，定义新设备命令
   ```

3. **BleDeviceManager.swift**
   ```swift
   // 在各方法中添加新设备的处理分支
   ```

4. **BleAPI.swift**
   ```swift
   // 添加新设备专用的公开方法
   ```

### 2. 添加自定义过滤器

创建新类实现 `BleFilterProtocol`：

```swift
// Filters/MyCustomFilter.swift
class MyCustomFilter: BleFilterProtocol {
    var filterName: String { "MyFilter" }
    func shouldInclude(peripheral: CBPeripheral) -> Bool {
        // 自定义逻辑
    }
}
```

### 3. 添加新的命令

在对应的设备命令文件中添加：

```swift
// Commands/SpiromerterCommands.swift
public enum SpirometerCommand {
    case newCommand = "新命令"  // 添加新命令
}
```

## 📈 代码统计

| 类型 | 数量 | 说明 |
|------|------|------|
| 核心类 | 3 | BleAPI, BleCentral, BleConstants |
| 数据模型 | 3 | BleDevice, BleFilter, BleError |
| 协议接口 | 3 | Device, Filter, Command |
| 过滤器实现 | 3 | Name, RSSI, DeviceType |
| 设备管理器 | 1 | BleDeviceManager |
| 命令定义 | 1 | SpiromerterCommands |
| 存储管理 | 1 | BleStorage |
| 工具类 | 3 | AES, DataConverter, BleDataConverter |
| **总计** | **18** | - |

## 🎨 设计模式应用

| 模式 | 应用位置 | 说明 |
|------|----------|------|
| **单例模式** | BleAPI, BleCentral, BleDeviceManager | 全局唯一实例 |
| **协议模式** | 所有 Protocols/ 文件 | 面向接口编程 |
| **工厂模式** | BleDeviceManager | 根据设备类型创建不同处理逻辑 |
| **策略模式** | BleFilterProtocol | 可替换的过滤策略 |
| **建造者模式** | CommandBuilder 类 | 构建复杂命令对象 |
| **观察者模式** | 各种回调 (onDeviceFound, etc) | 事件通知 |
| **代理模式** | CBCentralManagerDelegate | CoreBluetooth 代理 |

## 📚 相关文档

- [SDK重构说明.md](./SDK重构说明.md) - 详细的重构说明
- [重构迁移指南.md](./重构迁移指南.md) - 从旧版本迁移的指南
- [新架构使用示例.swift](./新架构使用示例.swift) - 完整的使用示例
- [已连接设备扫描功能说明.md](./已连接设备扫描功能说明.md) - 已连接设备功能

---

**文档版本**: v2.0  
**更新日期**: 2025年12月11日  
**维护者**: BleToolsKit Team

