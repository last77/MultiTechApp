# BleToolsKit 重构迁移指南

## 📊 文件结构对比

### 旧结构（扁平化）

```
BleToolsKit/
├── AESCBCutil.swift
├── Base64Converter.swift
├── BleAPI.swift
├── BleCentral.swift
├── BleConstants.swift
├── BleDataConverter.swift
├── BleDeviceNameFilter.swift
├── BlePublic.swift
├── BleStorage.swift
└── DataConverter.swift
```

### 新结构（模块化）

```
BleToolsKit/
├── Core/                          # 核心功能
│   ├── BleAPI.swift
│   ├── BleCentral.swift
│   └── BleConstants.swift
├── Models/                        # 数据模型
│   ├── BleDevice.swift
│   ├── BleFilter.swift
│   └── BleError.swift
├── Protocols/                     # 扩展接口
│   ├── BleDeviceProtocol.swift
│   ├── BleFilterProtocol.swift
│   └── BleCommandProtocol.swift
├── Filters/                       # 过滤器
│   └── BleDeviceNameFilter.swift
├── Devices/                       # 设备管理
│   └── BleDeviceManager.swift
├── Commands/                      # 命令定义
│   └── SpiromerterCommands.swift
├── Storage/                       # 存储
│   └── BleStorage.swift
└── Utils/                         # 工具
    ├── Crypto/
    │   └── AESCBCUtil.swift
    └── Converters/
        ├── BleDataConverter.swift
        ├── DataConverter.swift
        └── Base64Converter.swift
```

## 🔄 文件映射关系

| 旧文件 | 新位置 | 状态 |
|--------|--------|------|
| `BleAPI.swift` | `Core/BleAPI.swift` | ✅ 已重构 |
| `BleCentral.swift` | `Core/BleCentral.swift` | ⏳ 需更新引用 |
| `BleConstants.swift` | `Core/BleConstants.swift` | ✅ 已复制 |
| `BlePublic.swift` | 拆分为多个文件 | ✅ 已拆分 |
| ├─ `BleDevice` | `Models/BleDevice.swift` | ✅ 已重构 |
| ├─ `BleFilter` | `Models/BleFilter.swift` | ✅ 已重构 |
| └─ `BleError` | `Models/BleError.swift` | ✅ 已重构 |
| `BleDeviceNameFilter.swift` | `Filters/BleDeviceNameFilter.swift` | ✅ 已重构 |
| `BleStorage.swift` | `Storage/BleStorage.swift` | ✅ 已复制 |
| `AESCBCutil.swift` | `Utils/Crypto/AESCBCUtil.swift` | ✅ 已复制 |
| `BleDataConverter.swift` | `Utils/Converters/BleDataConverter.swift` | ✅ 已复制 |
| `DataConverter.swift` | `Utils/Converters/DataConverter.swift` | ✅ 已复制 |
| `Base64Converter.swift` | `Utils/Converters/Base64Converter.swift` | ✅ 已复制 |
| - | `Protocols/*.swift` | ✨ 新增 |
| - | `Devices/BleDeviceManager.swift` | ✨ 新增 |
| - | `Commands/SpiromerterCommands.swift` | ✨ 新增 |

## 📝 API 变更对比

### 1. 扫描设备回调

#### 旧版本

```swift
ble.onDeviceFound = { deviceId, deviceName, rssi in
    print("设备ID: \(deviceId)")
    print("设备名: \(deviceName)")
    print("信号: \(rssi)")
    
    // 需要手动判断是否已连接
    if rssi == 0 {
        print("这是已连接设备")
    }
}
```

#### 新版本 ✨

```swift
ble.onDeviceFound = { deviceInfo in
    print("设备ID: \(deviceInfo.deviceId)")
    print("设备名: \(deviceInfo.deviceName)")
    print("信号: \(deviceInfo.rssi)")
    
    // 直接使用结构化属性
    if deviceInfo.isConnected {
        print("这是已连接设备")
    }
    
    // 更多信息
    print("设备类型: \(deviceInfo.deviceType.rawValue)")
    print("MAC地址: \(deviceInfo.macAddress ?? "无")")
    print("是否新设备: \(deviceInfo.isNewDevice)")
}
```

### 2. 扫描方法

#### 旧版本

```swift
// 只能控制是否包含已连接设备
ble.scan(includeConnectedDevices: true)
```

#### 新版本 ✨

```swift
// 支持自定义过滤器
ble.scan(
    includeConnectedDevices: true,
    customFilter: myCustomFilter  // 可选的自定义过滤器
)

// 内置过滤器示例
let rssiFilter = BleRSSIFilter(minimumRSSI: -70)
let nameFilter = BleDeviceNameFilter.shared
let compositeFilter = CompositeFilter(
    filters: [rssiFilter, nameFilter],
    logic: .and
)

ble.scan(customFilter: compositeFilter)
```

### 3. 新增方法

#### 获取当前设备信息

```swift
// 新增
if let currentDevice = ble.getCurrentDevice() {
    print("当前连接: \(currentDevice.deviceName)")
    print("设备类型: \(currentDevice.deviceType)")
}
```

#### 获取所有已扫描设备

```swift
// 新增
let devices = ble.getScannedDevices()
for device in devices {
    print("\(device.deviceName) - \(device.isConnected ? "已连接" : "未连接")")
}
```

#### 断开连接回调

```swift
// 新增
ble.onDisconnected = {
    print("设备已断开")
}
```

## 🚀 迁移步骤

### Step 1: 更新回调签名

**旧代码：**
```swift
ble.onDeviceFound = { deviceId, deviceName, rssi in
    self.deviceList.append((deviceId, deviceName, rssi))
}
```

**新代码：**
```swift
ble.onDeviceFound = { deviceInfo in
    self.deviceList.append(deviceInfo)  // 直接存储 BleDeviceInfo
}
```

### Step 2: 更新设备列表模型

**旧代码：**
```swift
struct DeviceItem {
    let id: String
    let name: String
    let rssi: Int
}
```

**新代码：**
```swift
// 直接使用 BleDeviceInfo
typealias DeviceItem = BleDeviceInfo

// 或者包装
struct DeviceItem {
    let info: BleDeviceInfo
    var displayName: String {
        return "\(info.deviceName) (\(info.deviceType.rawValue))"
    }
}
```

### Step 3: 更新 UI 显示逻辑

**旧代码：**
```swift
func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
    let device = deviceList[indexPath.row]
    cell.textLabel?.text = device.1  // name
    cell.detailTextLabel?.text = "RSSI: \(device.2)"
}
```

**新代码：**
```swift
func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
    let device = deviceList[indexPath.row]
    
    // 更丰富的信息
    cell.textLabel?.text = device.deviceName
    cell.detailTextLabel?.text = """
    类型: \(device.deviceType.rawValue) | \
    信号: \(device.rssi) | \
    \(device.isConnected ? "已连接" : "未连接")
    """
    
    // 根据状态设置图标
    if device.isConnected {
        cell.imageView?.image = UIImage(systemName: "checkmark.circle.fill")
    } else {
        cell.imageView?.image = UIImage(systemName: "circle")
    }
}
```

### Step 4: 利用新功能

```swift
// 添加自定义过滤器
class MyDeviceFilter: BleFilterProtocol {
    var filterName: String { "MyFilter" }
    
    func shouldInclude(peripheral: CBPeripheral) -> Bool {
        // 只显示信号强度 > -70 的设备
        // 注意：这里需要配合 RSSI 过滤器使用
        return true
    }
}

// 使用新功能
let filter = MyDeviceFilter()
ble.scan(includeConnectedDevices: true, customFilter: filter)

// 获取当前连接设备
if let current = ble.getCurrentDevice() {
    print("当前: \(current.deviceName)")
}

// 查看所有已扫描设备
let all = ble.getScannedDevices()
print("共扫描到 \(all.count) 个设备")
```

## 🔧 Xcode 项目配置

### 1. 更新文件引用

在 Xcode 项目中：

1. **删除旧文件引用**（不要删除磁盘文件）：
   - 右键点击旧文件 → Remove Reference

2. **添加新文件夹**：
   - 右键项目根目录 → Add Files to "BleToolsKit"
   - 选择新创建的文件夹（Core、Models、Protocols 等）
   - ✅ 勾选 "Create groups"
   - ✅ 勾选目标（BleToolsKit target）

3. **验证编译**：
   - Cmd + B 编译项目
   - 解决任何导入错误

### 2. 更新 Import 语句

如果有外部引用，可能需要更新：

```swift
// 旧代码
import BleToolsKit

// 新代码（无需更改，模块名不变）
import BleToolsKit
```

### 3. 更新 Swift Package（如果使用）

如果你的项目作为 Swift Package 分发，需要更新 `Package.swift`：

```swift
// Package.swift
let package = Package(
    name: "BleToolsKit",
    products: [
        .library(
            name: "BleToolsKit",
            targets: ["BleToolsKit"]),
    ],
    targets: [
        .target(
            name: "BleToolsKit",
            dependencies: [],
            path: "BleToolsKit"
        ),
    ]
)
```

## ⚠️ 注意事项

### 1. 向后兼容

- **重要**：旧的文件仍然保留在根目录
- 新代码在各个子文件夹中
- 迁移期间两者可以并存
- 建议逐步迁移，避免一次性大改

### 2. 编译问题

如果遇到编译错误：

```
Cannot find 'BleDevice' in scope
```

**解决方案**：
- 确保新的 `Models/BleDevice.swift` 已加入项目
- 清理构建：Shift + Cmd + K
- 重新编译：Cmd + B

### 3. 命名冲突

如果新旧文件同时存在导致命名冲突：

```swift
// 使用完整路径指定
typealias OldBleDevice = BleToolsKit.BleDevice  // 旧版本
typealias NewBleDeviceInfo = BleToolsKit.BleDeviceInfo  // 新版本
```

## 📋 迁移检查清单

- [ ] 备份原始代码
- [ ] 创建新的文件夹结构
- [ ] 复制文件到新位置
- [ ] 更新 Xcode 项目引用
- [ ] 更新回调签名（`onDeviceFound`）
- [ ] 更新设备列表数据结构
- [ ] 更新 UI 显示逻辑
- [ ] 测试扫描功能
- [ ] 测试连接功能
- [ ] 测试命令发送
- [ ] 删除旧文件（可选，建议保留一段时间）
- [ ] 更新文档

## 🎯 迁移优先级

### 高优先级（必须立即迁移）

1. ✅ `onDeviceFound` 回调签名
2. ✅ 设备列表数据结构

### 中优先级（建议迁移）

1. ⚙️ 使用 `BleDeviceInfo` 的新属性（`isConnected`、`deviceType`）
2. ⚙️ 添加 `onDisconnected` 回调
3. ⚙️ 使用 `getCurrentDevice()` 和 `getScannedDevices()`

### 低优先级（可选）

1. 💡 使用自定义过滤器
2. 💡 扩展新设备类型
3. 💡 实现自定义命令

## 📚 示例代码

完整的迁移示例请参考：

- [已连接设备扫描示例.swift](./已连接设备扫描示例.swift) - 最新使用示例
- [SDK重构说明.md](./SDK重构说明.md) - 详细架构说明

## 🆘 常见问题

### Q1: 必须立即迁移吗？

**A**: 不是必须的。旧代码仍然可以工作，但建议逐步迁移以享受新功能。

### Q2: 迁移后会影响现有功能吗？

**A**: 不会。核心功能保持不变，只是增加了更多信息和扩展性。

### Q3: 如何测试迁移是否成功？

**A**: 运行以下测试：
```swift
// 测试扫描
ble.scan()

// 测试连接
ble.connect(deviceId: "xxx")

// 测试新功能
let devices = ble.getScannedDevices()
print("扫描到 \(devices.count) 个设备")
```

### Q4: 旧文件什么时候可以删除？

**A**: 建议在新架构稳定运行 1-2 周后再删除旧文件。

---

**迁移指南版本**: v1.0  
**更新日期**: 2025年12月11日  
**联系方式**: BleToolsKit Team

